version: "3.8"
services:
  init_{{ worker_name }}:
    container_name: init_{{ worker_name }}
    image: alloranetwork/allora-chain:latest
    volumes:
      - type: bind
        source: ./data
        target: /data
    command: 
      - /bin/sh
      - -c
      - |
        set -ex

        if allorad keys --keyring-backend test show {{ worker_name }} >/dev/null 2>&1 ; then
          echo "{{ worker_name }} account already imported"
        else
          echo "Importing account {{ worker_name }} from hexcoded private key"
          allorad keys import-hex --home=/data/.allorad --keyring-backend test {{ worker_name }} {{ hex_coded_pk }}
        fi
  {{ worker_name }}:
    container_name: {{ worker_name }}
    build: .
    command:
      - allora-node
      - --role=worker
      - --peer-db=/data/worker/peer-database
      - --function-db=/data/worker/function-database
      - --runtime-path=/app/runtime
      - --runtime-cli=bls-runtime
      - --workspace=/data/worker/workspace
      - --private-key=/data/worker/key/priv.bin
      - --log-level=debug
      - --port=9010
      - --boot-nodes={{ boot_nodes }}
      - --topic={{ topic_id }}
      - --allora-node-rpc-address={{ chain_rpc_address }}
      - --allora-chain-home-dir=/data/.allorad
      - --allora-chain-key-name={{ worker_name}}
      - --allora-chain-topic-id={{ topic_id }}
    volumes:
      - type: bind
        source: ./data
        target: /data
    env_file:
      - .env
    ports:
      - "9010:9010"
    depends_on:
      - init
