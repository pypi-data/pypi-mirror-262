workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

variables:
  # make sure the CI system checks out the submodules
  GIT_SUBMODULE_STRATEGY: recursive
  WHEEL_PROTOBUF_VERSION: "3.20.3"


tests:
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.9", "3.10", "3.11", "3.12"]

  image: python:${PYTHON_VERSION}

  variables:
    # needed to avoid interactive prompts during installation
    DEBIAN_FRONTEND: "noninteractive"

  before_script:
    # install build dependencies
    - apt update && apt install -y cmake libzmq3-dev libprotobuf-dev protobuf-compiler
    - python --version

  script:
    - python -m pip install '.[all]'
    - python -m pytest -v --pyargs protozfits



build_wheels:
  rules:
    - if: $CI_COMMIT_TAG
  image: quay.io/pypa/manylinux2014_x86_64
  stage: deploy
  before_script:
    - ulimit -n 1024 && yum install -y zeromq-devel zlib-devel
    - cd /tmp
    - curl -sSfL https://github.com/protocolbuffers/protobuf/releases/download/v${WHEEL_PROTOBUF_VERSION}/protobuf-all-${WHEEL_PROTOBUF_VERSION}.tar.gz | tar xz
    - cd protobuf-${WHEEL_PROTOBUF_VERSION}
    - cmake -S cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -Dprotobuf_BUILD_TESTS=OFF
    - cmake --build build -- -j 2
    - cmake --install build
    - protoc --version
    - cd $CI_PROJECT_DIR

  script:
    - ./dev/build_wheels.sh

  artifacts:
    paths:
      - dist/*


pypi:
  rules:
    - if: $CI_COMMIT_TAG
  stage: deploy
  needs:
    - "build_wheels"
  image: "python:3.12-slim"
  before_script:
    - pip install -U twine
  script:
    - twine upload dist/*
  variables:
    TWINE_NON_INTERACTIVE: "true"
    TWINE_USERNAME: "__token__"
