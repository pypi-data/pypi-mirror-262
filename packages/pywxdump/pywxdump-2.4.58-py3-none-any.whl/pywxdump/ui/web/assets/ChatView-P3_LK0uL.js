import{C as O,_ as F}from"./ChatRecprdsHeader-Jw1_5v4C.js";import{h as H}from"./axios--FnjuHWf.js";import{d as p,o as c,c as o,a as e,t as u,_ as b,r as y,b as h,e as v,f as z,u as I,i as L,g as j,w,h as T,j as E,k as V,F as q,l as B,m as S,n as C}from"./index-fo74kDp0.js";import{_ as P}from"./IsAutoShow.vue_vue_type_script_setup_true_xmlns_http%3A%2F%2Fwww.w3.org%2F1999%2Fhtml_lang-H5Rouoe9.js";import{_ as A}from"./HomeView.vue_vue_type_script_setup_true_lang-ovFYTfHs.js";const W={class:"chat-content"},G={key:0,class:"word"},J=["src"],K={class:"info"},Q={class:"time"},X=["innerHTML"],Y={key:1,class:"word-my"},Z={class:"info"},ee={class:"time"},te=["innerHTML"],se=["src"],ne=p({__name:"MessageText",props:{is_sender:{type:Number,default:0},content:{type:String,default:""},headUrl:{type:String,default:""},direction:{type:String,default:""}},setup(t){const a=i=>(i=i.replace(/\n/g,"<br>"),new DOMParser().parseFromString(i,"text/html").body.innerHTML);return(i,n)=>(c(),o("div",W,[t.is_sender?(c(),o("div",Y,[e("div",Z,[e("p",ee,u(t.direction),1),e("div",{class:"info-content",innerHTML:a(t.content)},null,8,te)]),e("img",{src:t.headUrl},null,8,se)])):(c(),o("div",G,[e("img",{src:t.headUrl},null,8,J),e("div",K,[e("p",Q,u(t.direction),1),e("div",{class:"info-content",innerHTML:a(t.content)},null,8,X)])]))]))}}),ie=b(ne,[["__scopeId","data-v-d930be9e"]]),ce={class:"chat-content"},oe={key:0,class:"word"},ae=["src"],re={class:"info"},le={class:"time"},de={class:"demo-image__preview"},_e={key:1,class:"word-my"},ue={class:"info"},he={class:"time"},fe={class:"demo-image__preview"},ve=["src"],me=p({__name:"MessageImg",props:{is_sender:{type:Number,default:0},content:{type:String,default:""},headUrl:{type:String,default:""},direction:{type:String,default:""},src:{type:String,default:""}},setup(t){return(a,i)=>{const n=y("el-image");return c(),o("div",ce,[t.is_sender?(c(),o("div",_e,[e("div",ue,[e("p",he,u(t.direction),1),e("div",fe,[h(n,{style:{"max-width":"150px","max-height":"150px"},src:t.src,"zoom-rate":1.2,"max-scale":7,"min-scale":.2,"preview-src-list":[t.src],"initial-index":4,fit:"cover"},null,8,["src","preview-src-list"])])]),e("img",{src:t.headUrl},null,8,ve)])):(c(),o("div",oe,[e("img",{src:t.headUrl},null,8,ae),e("div",re,[e("p",le,u(t.direction),1),e("div",de,[h(n,{style:{"max-width":"150px","max-height":"150px"},src:t.src,"zoom-rate":1.2,"max-scale":7,"min-scale":.2,"preview-src-list":[t.src],"initial-index":4,fit:"cover"},null,8,["src","preview-src-list"])])])]))])}}}),ye=b(me,[["__scopeId","data-v-24d6aaa0"]]),pe={class:"chat-content"},$e={key:0,class:"word"},ge=["src"],we={class:"info"},ke={class:"time"},xe={class:"demo-video__preview"},Se={controls:"",width:"30%"},be=["src"],Ue={key:1,class:"word-my"},Me={class:"info"},Te={class:"time"},De={class:"demo-video__preview"},ze={controls:"",width:"50%"},He=["src"],Ce=["src"],Ne=p({__name:"MessageVideo",props:{is_sender:{type:Number,default:0},content:{type:String,default:""},headUrl:{type:String,default:""},direction:{type:String,default:""},src:{type:String,default:""}},setup(t){const a=t,i=v("");return z(async()=>{i.value=`/api/video/${a.src}`}),(n,d)=>(c(),o("div",pe,[t.is_sender?(c(),o("div",Ue,[e("div",Me,[e("p",Te,u(t.direction),1),e("div",De,[e("video",ze,[e("source",{src:i.value,type:"video/mp4"},null,8,He)])])]),e("img",{src:t.headUrl},null,8,Ce)])):(c(),o("div",$e,[e("img",{src:t.headUrl},null,8,ge),e("div",we,[e("p",ke,u(t.direction),1),e("div",xe,[e("video",Se,[e("source",{src:i.value,type:"video/mp4"},null,8,be)])])])]))]))}}),Ie=b(Ne,[["__scopeId","data-v-f0fe7ab3"]]),Le={class:"chat-content"},Re={key:0,class:"word"},Oe=["src"],Fe={class:"info"},je={class:"time"},Ee={controls:"",style:{"background-color":"#fff"}},Ve=["src"],qe={key:1,class:"word-my"},Be={class:"info"},Pe={class:"time"},Ae={controls:"",style:{"background-color":"#95EC69"}},We=["src"],Ge=["src"],Je=p({__name:"MessageAudio",props:{is_sender:{type:Number,default:0},headUrl:{type:String,default:""},direction:{type:String,default:""},src:{type:String,default:""},msg:{type:String,default:""}},setup(t){return(a,i)=>(c(),o("div",Le,[t.is_sender?(c(),o("div",qe,[e("div",Be,[e("p",Pe,u(t.direction),1),e("audio",Ae,[e("source",{src:t.src,type:"audio/wav"},null,8,We)]),h(I(L),{rows:1,readonly:!0,value:t.msg,style:{width:"100%"}},null,8,["value"])]),e("img",{src:t.headUrl},null,8,Ge)])):(c(),o("div",Re,[e("img",{src:t.headUrl},null,8,Oe),e("div",Fe,[e("p",je,u(t.direction),1),e("audio",Ee,[e("source",{src:t.src,type:"audio/wav"},null,8,Ve)]),h(I(L),{rows:1,readonly:!0,value:t.msg,style:{width:"100%"}},null,8,["value"])])]))]))}}),Ke=b(Je,[["__scopeId","data-v-0d0f2cd4"]]),Qe={class:"chat-content"},Xe={key:0,class:"word"},Ye=["src"],Ze={class:"info"},et={class:"time"},tt={style:{float:"left"}},st=["href"],nt={key:1,class:"word-my"},it={class:"info"},ct={class:"time"},ot={style:{float:"right"}},at=["href"],rt=["src"],lt=p({__name:"MessageFile",props:{is_sender:{type:Number,default:0},content:{type:String,default:""},headUrl:{type:String,default:""},direction:{type:String,default:""},src:{type:String,default:""}},setup(t){const a=t,i=v(""),n=j({file_name:String,file_size:Number,file_size_unit:String});z(async()=>{console.log("文件加载中");const l=await d(a.src);console.log(l),n.file_name=l.file_name,n.file_size=Number(l.file_size)/1024,n.file_size<1024?n.file_size_unit="kb":(n.file_size=n.file_size/1024,n.file_size_unit="mb"),n.file_size=Number(l.file_size)/1024,i.value=`/api/file/${a.src}`});const d=async l=>{try{return await H.post("/api/file_info",{file_path:l})}catch(m){return console.error("Error fetching file_info:",m),""}};return(l,m)=>{const r=y("el-card");return c(),o("div",Qe,[t.is_sender?(c(),o("div",nt,[e("div",it,[e("p",ct,u(t.direction),1),e("div",ot,[h(r,{shadow:"hover",style:{width:"fit-content"}},{default:w(()=>[T("文件 ： "),e("a",{href:i.value,download:""},u(n.file_name),9,at),e("div",null,[T(" 文件大小："),e("span",null,u(n.file_size)+u(n.file_size_unit),1)])]),_:1})])]),e("img",{src:t.headUrl},null,8,rt)])):(c(),o("div",Xe,[e("img",{src:t.headUrl},null,8,Ye),e("div",Ze,[e("p",et,u(t.direction),1),e("div",tt,[h(r,{shadow:"hover",style:{width:"fit-content"}},{default:w(()=>[T("文件 ： "),e("a",{href:i.value,download:""},u(n.file_name),9,st),e("div",null,[T(" 文件大小："),e("span",null,u(n.file_size)+u(n.file_size_unit),1)])]),_:1})])])]))])}}}),dt=b(lt,[["__scopeId","data-v-9dc49946"]]),_t={class:"chat-content"},ut={key:0,class:"word"},ht=["src"],ft={class:"info"},vt={class:"time"},mt={class:"demo-image__preview"},yt={key:1,class:"word-my"},pt={class:"info"},$t={class:"time"},gt={class:"demo-image__preview"},wt=["src"],kt=p({__name:"MessageEmoji",props:{is_sender:{type:Number,default:0},content:{type:String,default:""},headUrl:{type:String,default:""},direction:{type:String,default:""},src:{type:String,default:""}},setup(t){const a=t,i=v("");return z(()=>{i.value=a.src}),(n,d)=>{const l=y("el-image");return c(),o("div",_t,[t.is_sender?(c(),o("div",yt,[e("div",pt,[e("p",$t,u(t.direction),1),e("div",gt,[h(l,{style:{"max-width":"150px","max-height":"150px"},src:i.value,"zoom-rate":1.2,"max-scale":7,"min-scale":.2,"preview-src-list":[i.value],"initial-index":4,fit:"cover"},null,8,["src","preview-src-list"])])]),e("img",{src:t.headUrl},null,8,wt)])):(c(),o("div",ut,[e("img",{src:t.headUrl},null,8,ht),e("div",ft,[e("p",vt,u(t.direction),1),e("div",mt,[h(l,{style:{"max-width":"150px","max-height":"150px"},src:i.value,"zoom-rate":1.2,"max-scale":7,"min-scale":.2,"preview-src-list":[i.value],"initial-index":4,fit:"cover"},null,8,["src","preview-src-list"])])])]))])}}}),xt=b(kt,[["__scopeId","data-v-39abf529"]]),St={class:"chat-content"},bt={key:0,class:"word"},Ut=["src"],Mt={class:"info"},Tt={class:"time"},Dt=["innerHTML"],zt={key:1,class:"word-my"},Ht={class:"info"},Ct={class:"time"},Nt=["innerHTML"],It=["src"],Lt=p({__name:"MessageOther",props:{is_sender:{type:Number,default:0},content:{type:String,default:""},headUrl:{type:String,default:""},direction:{type:String,default:""}},setup(t){const a=i=>(i=i.replace(/\n/g,"<br>"),new DOMParser().parseFromString(i,"text/html").body.innerHTML);return(i,n)=>(c(),o("div",St,[t.is_sender?(c(),o("div",zt,[e("div",Ht,[e("p",Ct,u(t.direction),1),e("div",{class:"info-content",innerHTML:a(t.content)},null,8,Nt)]),e("img",{src:t.headUrl},null,8,It)])):(c(),o("div",bt,[e("img",{src:t.headUrl},null,8,Ut),e("div",Mt,[e("p",Tt,u(t.direction),1),e("div",{class:"info-content",innerHTML:a(t.content)},null,8,Dt)])]))]))}}),Rt=b(Lt,[["__scopeId","data-v-e529325a"]]),Ot={id:"chat"},Ft={class:"chat_body"},jt={class:"chat_window",ref:"chatWindow"},Et={key:0,class:"load_more",style:{display:"flex","justify-content":"center","margin-top":"10px","margin-bottom":"10px"}},Vt=p({__name:"ChatRecordsMain",props:{userData:{type:Object,required:!0},setScrollTop:{type:Function,required:!0},updateScrollTop:{type:Function,required:!0}},setup(t,{expose:a}){const i=t,n=v([]),d=v({}),l=v(""),m=v(50),r=v(0),k=v(!1),M=async(_,x,f)=>{try{const s=await H.post("/api/msgs",{start:_,limit:x,wxid:f});return n.value=s.msg_list,d.value=s.user_list,l.value=s.my_wxid,s}catch(s){return console.error("Error fetching data:",s),[]}},D=async()=>{try{r.value=i.userData.chat_count-m.value,await M(r.value,m.value,i.userData.username),k.value||await C(()=>{i.setScrollTop(),k.value=!1})}catch(_){return console.error("Error fetching data:",_),[]}};z(D),E(()=>i.userData.username,(_,x)=>{console.log("username changed",_,x),n.value=[],k.value=!1,D()});const $=_=>(_.talker=="我"&&(_.talker=l.value),`${(f=>d.value.hasOwnProperty(f.talker)?d.value[f.talker].remark?d.value[f.talker].remark:d.value[f.talker].nickname?d.value[f.talker].nickname:d.value[f.talker].account?d.value[f.talker].account:f.talker:f.talker)(_)} [${_.type_name}] ${_.CreateTime}`),g=_=>(_.talker=="我"&&(_.talker=l.value),d.value.hasOwnProperty(_.talker)?d.value[_.talker].headImgUrl:""),N=async()=>{let _=m.value,x=r.value-_;const f=await H.post("/api/msgs",{start:x,limit:_,wxid:i.userData.username});r.value=x,n.value=f.msg_list.concat(n.value),n.value.sort((s,U)=>s.id-U.id),n.value=n.value.filter((s,U,R)=>U===0||s.id!==R[U-1].id),d.value=Object.assign(d.value,f.user_list),await C(()=>{i.updateScrollTop()})};return a({loadMore:N}),(_,x)=>{const f=y("el-button");return c(),o("div",Ot,[e("div",Ft,[e("div",jt,[n.value.length<t.userData.chat_count?(c(),o("div",Et,[h(f,{type:"primary",onClick:N},{default:w(()=>[T("查看更多消息")]),_:1})])):V("",!0),(c(!0),o(q,null,B(n.value,(s,U)=>(c(),o("div",{class:"message",key:U},[s.type_name=="文本"?(c(),S(ie,{key:0,is_sender:s.is_sender,direction:$(s),headUrl:g(s),content:s.content.msg},null,8,["is_sender","direction","headUrl","content"])):s.type_name=="图片"?(c(),S(ye,{key:1,is_sender:s.is_sender,direction:$(s),headUrl:g(s),src:"/api/img?img_path="+s.content.src},null,8,["is_sender","direction","headUrl","src"])):s.type_name=="动画表情"?(c(),S(xt,{key:2,is_sender:s.is_sender,direction:$(s),headUrl:g(s),src:s.content.src},null,8,["is_sender","direction","headUrl","src"])):s.type_name=="视频"?(c(),S(Ie,{key:3,is_sender:s.is_sender,direction:$(s),headUrl:g(s),src:s.content.src},null,8,["is_sender","direction","headUrl","src"])):s.type_name=="文件"?(c(),S(dt,{key:4,is_sender:s.is_sender,direction:$(s),headUrl:g(s),src:s.content.src},null,8,["is_sender","direction","headUrl","src"])):s.type_name=="语音"?(c(),S(Ke,{key:5,is_sender:s.is_sender,direction:$(s),headUrl:g(s),src:"/api/"+s.content.src,msg:s.content.msg},null,8,["is_sender","direction","headUrl","src","msg"])):(c(),S(Rt,{key:6,is_sender:s.is_sender,direction:$(s),headUrl:g(s),content:s.content.msg},null,8,["is_sender","direction","headUrl","content"]))]))),128))],512)])])}}}),qt=b(Vt,[["__scopeId","data-v-c286032e"]]),Bt=p({__name:"ChatRecords",props:{userData:{type:Object,required:!0}},setup(t){const a=v(null),i=v(null);v(0);const n=v(0),d=()=>{C(()=>{if(a.value){const r=a.value.$el.children[0];r&&(r.scrollTop=r.scrollHeight,n.value=r.scrollHeight)}})},l=()=>{const r=a.value.$el.children[0];if(r){const k=n.value,M=r.scrollHeight-k;r.scrollTop=r.scrollTop+M,n.value=r.scrollHeight}};function m({scrollTop:r}){r===0&&i.value&&i.value.loadMore()}return(r,k)=>{const M=y("el-header"),D=y("el-scrollbar"),$=y("el-main"),g=y("el-container");return c(),S(g,null,{default:w(()=>[h(M,{style:{height:"65px","max-height":"65px",width:"100%","background-color":"#d2d2fa","padding-top":"5px"}},{default:w(()=>[h(O,{userData:t.userData},null,8,["userData"])]),_:1}),h($,{style:{"overflow-y":"auto",height:"calc(100vh - 65px)",padding:"0"}},{default:w(()=>[h(D,{ref_key:"scrollbarRef",ref:a,onScroll:m},{default:w(()=>[h(qt,{ref_key:"chatRecordsMainRef",ref:i,userData:t.userData,setScrollTop:d,updateScrollTop:l},null,8,["userData"])]),_:1},512)]),_:1})]),_:1})}}}),Pt={id:"chat_view",class:"common-layout"},At={key:0},Wt={key:1},Gt={key:0,style:{height:"calc(100vh)",width:"100%"}},Jt={key:1,style:{width:"100%",height:"100%"}},es=p({__name:"ChatView",setup(t){const a=v({account:"",describe:"",headImgUrl:"",nickname:"",remark:"",username:"",chat_count:0}),i=l=>{a.value=l},n=v(!1),d=l=>{n.value=l};return(l,m)=>{const r=y("el-aside"),k=y("el-container");return c(),o("div",Pt,[n.value?(c(),o("div",Wt,[h(k,null,{default:w(()=>[h(r,{width:"auto",style:{"overflow-y":"auto",height:"calc(100vh)"}},{default:w(()=>[h(F,{onUserData:i})]),_:1}),a.value.username!=""?(c(),o("div",Gt,[h(Bt,{userData:a.value},null,8,["userData"])])):(c(),o("div",Jt,[h(A)]))]),_:1})])):(c(),o("div",At,[h(P,{onIsAutoShow:d})]))])}}});export{es as default};
